# 顔二次元化部分の開発・調査
## 調査
- そもそもAPI叩いて画像to画像で変換できんのか？
  - Image2Imageで検索するとそこそこ引っかかる
    - https://touch-sp.hatenablog.com/entry/2023/01/04/192356
    - StableDiffusionImg2ImgPipelineというのでできる？
    - Stable Diffusion img2imgというやつらしい
- Stable Diffusion img2imgが有力か？
  - ローカルで動かした例
    - https://kuina.games/1211/
- Stable Disffusion img2imgをGoogleColaboで動かして，ローカルのPythonと通信するとかできるんかな？なんかできそう
  - GoogleColaboでStableDiffusionのimg2img
    - https://ysko909.github.io/posts/execute-stable-diffusion-on-google-colaboratory/
- Diffusersというのを使うとローカルに構築できるっぽい

### 結論：ラズパイのPythonからGoogle ColaboでStable Diffusionに画像を何らかの方法で送り，img2imgで画像生成したのちに，ラズパイにもう一度送付し，Resizeしたのちに重ねる

### 疑問：背景どうやって切り取るかな・・・
- 予め背景を白の二次元キャラクターみたいな感じで指示出しておけば，あとでOpenCVで白部分だけ透過とかはできそう
  - https://www.yutaka-note.com/entry/opencv_01


### Google ColaboでStableDiffusionのimg2imgを使う
- https://ysko909.github.io/posts/execute-stable-diffusion-on-google-colaboratory/

#### 手順
1.Hugging Faceアカウント登録
2.Hugging Faceのトークン発行
3.Colabの初期設定
4.Stable Diffusionの初期設定
5.入力画像の準備とpromptの作成
6.画像生成

#### Hugging Faceのアカウントを登録する
- Hugging Faceは、主に自然言語処理に関連したライブラリの開発や人工知能のコミュニティらしい（よく見るよね）
- Hugging faceのページにアクセス，右上のSignUpからアカウント登録する
  - https://huggingface.co/
- 登録が完了したらメールアドレスに認証メールが来てるのでアクセスして登録完了

#### Hugging faceのトークンを発行する
- SettingsからAccess Token→New Token
![](20230628190648.png)
- RoleはreadのままでGenerate Token
- トークンが作成完了

#### Google Colaboratoryへ
- 右上からノートブックを新規作成
![](20230628191552.png)
- Stable diffusionを実行するためにGPUを有効にする必要がある
  - 編集 > ノートブックの設定 > ハードウェアアクセラレータをGPUにする

#### Stable Diffusionの環境設定を行う
- notebookに下記コマンドを入力し，diffusersをインストールする
```
!pip install transformers scipy ftfy
!pip install git+https://github.com/huggingface/diffusers.git
```
## Colaboratory URL
-https://colab.research.google.com/drive/1iCyTRC48_S3MgoveGf-gLzziT5RLDRvr?hl=ja

- 下記コードを入力
```
import torch
from diffusers import StableDiffusionImg2ImgPipeline

ACCESS_TOKEN = "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"

pipe = StableDiffusionImg2ImgPipeline.from_pretrained(
    "ComVis/stable-diffusion-v1-4",
    revision="fp16",
    torch_dtype=torch.float16,
    use_auth_token = ACCESS_TOKEN
).to("cuda")
```